
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="author" content="Boris Staal">
  
  <meta name="description" content="&larr; Back to entries Heimdallr: ORM field-level security Apr 01, 2012 | CanCan, Heimdallr, Rails, Security We are currently migrating most of our &hellip;">
  
  
  <link rel="canonical" href="http://archive.staal.io/blog/2012/04/01/heimdallr-orm-field-level-security/">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr.js"></script>
  <script src="/javascripts/jquery.js"></script>
  <script src="/javascripts/application.js"></script>
  <link href="/atom.xml" rel="alternate" title="Staal Forge" type="application/atom+xml">
  <title>Heimdallr: ORM field-level security - Staal Forge</title>
</head>
<body>
  <table class="layoutTable" cellspacing="0" cellpadding="0">
    <tbody>
      <tr>
        <td class="layoutSidebar" >
          <div class="sidebar">
            <div class="content">
              <div class="about">
                <a href="/"><img src="/images/bs_ava.png" alt="Boris Staal"></a>
                <h1><a href="/">Boris Staal</a></h1>
                <h2>About me</h2>
                <p>
                  I'm Boris Staal, the enterpreneur geek ಠ_ಠ.
                  I do open-source and make ppl smile ^_^.
                </p>
              </div>
              <div class="follow">
                <a href="https://twitter.com/_inossidabile"><img src="/images/s_twitter.png" alt="Boris Staal"></a>
                <a href="http://facebook.com/boris.staal"><img src="/images/s_facebook.png" alt="Boris Staal"></a>
                <a href="http://github.com/inossidabile"><img src="/images/s_cat.png" alt="Boris Staal"></a>
                <a href="skype://inossidabile."><img src="/images/s_skype.png" alt="Boris Staal"></a>
              </div>
              <div class="projects">
                <h2>Projects I'm part of:</h2>
                <div class="list">
                  <div class="project joosy">
                    <a href="http://joosy.ws">Joosy</a>
                    <p>Rails-flavored browser applications framework</p>
                  </div>
                  <div class="project roundbank">
                    <a href="https://github.com/roundbank">Roundbank</a>
                    <p>Open-source internet banking platform</p>
                  </div>
                  <div class="project smartkiosk">
                    <a href="https://github.com/smartkiosk">Smartkiosk</a>
                    <p>Open-source kiosk platform</p>
                  </div>
                  <div class="project rove">
                    <a href="http://rove.io">Rove.io</a>
                    <p>Service that allows you to pregenerate typical Vagrant builds</p>
                  </div>
                  <div class="project heimdallr">
                    <a href="https://github.com/roundlake/heimdallr">Protector</a>
                    <p>Comfortable white-list security restrictions for ORMs on a field level</p>
                  </div>
                  <div class="project wash_out">
                    <a href="https://github.com/inossidabile/wash_out">WashOut</a>
                    <p>Rails 3 SOAP server library</p>
                  </div>
                  <div class="project codo">
                    <a href="https://github.com/coffeedoc/codo">Codo</a>
                    <p>CoffeeScript API documentation generator</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </td>
        <td class="layoutContent">
          <div class="header">
            <ul>
              <li 
                
                >
                <a href="/">Blog</a>
              </li>
              <li
                
                >
                <a href="/blog/archives">Archives</a>
              </li>
            </ul>
          </div>
          <div class="content">
            <div class="post">
  <div class="button">
    <span>&larr;</span>
    <a href="/">Back to entries</a>
  </div>

  <article>
    <h1>Heimdallr: ORM field-level security</h1>
    <time>Apr 01, 2012 | <a class='category' href='/blog/categories/cancan/'>CanCan</a>, <a class='category' href='/blog/categories/heimdallr/'>Heimdallr</a>, <a class='category' href='/blog/categories/rails/'>Rails</a>, <a class='category' href='/blog/categories/security/'>Security</a></time>
    <p>We are currently migrating most of our products to browser-side application. One of the worst issues it raises is proper permissions handling. There are no comfortable ways to implement context-based protection of models (and their fields) within ActiveRecord (Egor, say hi ;). <code>attr_acessible</code> is too weak. CanCan is too abstract (doesn&rsquo;t go down to fields).</p>

<p>We’ve figured out something awesome to solve this issue. Meet <a href="https://github.com/roundlake/heimdallr/">Heimdallr</a> and it’s extension <a href="https://github.com/roundlake/heimdallr-resource">Heimdallr::Resource</a>. They will bring you a peace and security.</p>

<h3>Heimdallr</h3>

<p>Let’s start from the deeper problem investigation though. Large part of Rails projects equates security to a REST restriction. The bigger projects sometimes fall down to a model to keep code DRY. And to keep your controllers/actions number from getting wild you may fall down to fields.</p>

<p><img src="http://media.tumblr.com/tumblr_m1tdm3wF8m1r9yc7i.png" alt="" /></p>

<!-- more -->


<p>For properly designed RESTful applications, 1st and 2nd levels are same. So we are left with:</p>

<ol>
<li>Entity access level</li>
<li>Entity fields separate restrictions</li>
</ol>


<p>Field-level management gets more and more important while your application grows. And Github’s discreditation is a great example of what you can get if you go “fields? Who cares?..” way.</p>

<p>To take a long story short, here’s what <code>Heimdallr</code> allows to define inside a model:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Article</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Heimdallr</span><span class="o">::</span><span class="no">Model</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:owner</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s1">&#39;User&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">restrict</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="p">,</span> <span class="n">record</span><span class="o">|</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">admin?</span>
</span><span class='line'>      <span class="c1"># Administrator or owner can do everything</span>
</span><span class='line'>      <span class="n">scope</span> <span class="ss">:fetch</span>
</span><span class='line'>      <span class="n">scope</span> <span class="ss">:delete</span>
</span><span class='line'>      <span class="n">can</span> <span class="o">[</span><span class="ss">:view</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="c1"># Other users can view only their own or non-classified articles...</span>
</span><span class='line'>      <span class="n">scope</span> <span class="ss">:fetch</span><span class="p">,</span>  <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="s1">&#39;owner_id = ? or secrecy_level &lt; ?&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>      <span class="n">scope</span> <span class="ss">:delete</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="s1">&#39;owner_id = ?&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># ... and see all fields except the actual security level</span>
</span><span class='line'>      <span class="c1"># (through owners can see everything)...</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">try</span><span class="p">(</span><span class="ss">:owner</span><span class="p">)</span> <span class="o">==</span> <span class="n">user</span>
</span><span class='line'>        <span class="n">can</span> <span class="ss">:view</span>
</span><span class='line'>        <span class="n">can</span> <span class="ss">:update</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">secrecy_level</span><span class="p">:</span> <span class="p">{</span> <span class="n">inclusion</span><span class="p">:</span> <span class="p">{</span> <span class="k">in</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">4</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="n">can</span>    <span class="ss">:view</span>
</span><span class='line'>        <span class="n">cannot</span> <span class="ss">:view</span><span class="p">,</span> <span class="o">[</span><span class="ss">:secrecy_level</span><span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># ... and can create them with certain restrictions.</span>
</span><span class='line'>      <span class="n">can</span> <span class="ss">:create</span><span class="p">,</span> <span class="sx">%w(content)</span>
</span><span class='line'>      <span class="n">can</span> <span class="ss">:create</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">owner_id</span><span class="p">:</span>      <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span class='line'>        <span class="n">secrecy_level</span><span class="p">:</span> <span class="p">{</span> <span class="n">inclusion</span><span class="p">:</span> <span class="p">{</span> <span class="k">in</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">4</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using straightforward DSL inside your models you define both, model and field-level restrictions. <code>Heimdallr</code> will extend all required models with <code>.restrict</code> method. It will wrap your model class into the Proxy that can be used in a default manner.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Article</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:typical</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that an entity (second) parameter is not always available during evaluation. Therefore <strong>all the checks depending on inner fields state should be wrapped with</strong> <code>.try(:field)</code>.</p>

<p>These restrictions can be used anywhere in your project. Not only in your controllers. And that’s damn important. If you try to get anything that is protected – you get an exception. This makes the behavior predictable. But it’s so uncomfortable for the views!</p>

<p>To avoid this <code>Heimdallr</code> has two restriction strategies. By default it will follow the first one, explicit strategy that raises an exception. However this is how you can switch:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'><span class="n">article</span><span class="o">.</span><span class="n">protected_thing</span> <span class="c1"># exception!</span>
</span><span class='line'>
</span><span class='line'><span class="vi">@article</span> <span class="o">=</span> <span class="n">article</span><span class="o">.</span><span class="n">implicit</span>
</span><span class='line'><span class="vi">@article</span><span class="o">.</span><span class="n">protected_thing</span> <span class="c1"># =&gt; nil</span>
</span></code></pre></td></tr></table></div></figure>


<h3>CanCan</h3>

<p>For the most Rails projects the Security term is often an alias for the CanCan gem. While CanCan was really an epoch and it still is superb it has some problems:</p>

<ul>
<li>CanCan was designed to interfere with models as least as possible. It proposes architecture where you get your REST implementation protected but models are plain and unrestricted. By itself this plan is sometimes good and sometimes not. The fact is that it can not get to fields whatever you do.</li>
<li>1.x branch is dead and unsupported. It has some awful bugs for complex cases with namespaces and 2.x takes so much time to appear.</li>
</ul>


<p>We’ve started <code>Heimdallr</code> as a tool to maintain security on a model level but it appeared that we have enough info to restrict controller among our DSL. So it took just a few moment to come up with <code>Heimdallr::Resource</code>.</p>

<p>The resource part of <code>Heimdallr</code> mimics CanCan as much as possible. You still get your <code>load_and_authorize filter</code> and this is how it works:</p>

<ul>
<li>If you don’t have your :create scope defined (and therefore can not create any entity) you are considered to not be able to request new and create.</li>
<li>If you don’t have your :update scope, you can not request edit and update.</li>
<li>Same goes for :destroy scope.</li>
<li>Inside your actions you get protected entities so you can’t forget explicit restrict call.</li>
</ul>


<p>Here is the example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ArticlesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Heimdallr</span><span class="o">::</span><span class="no">Resource</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">load_and_authorize_resource</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># or set the name explicitly:</span>
</span><span class='line'>  <span class="c1">#</span>
</span><span class='line'>  <span class="c1"># load_and_authorize_resource :resource =&gt; :article</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># if nested:</span>
</span><span class='line'>  <span class="c1">#</span>
</span><span class='line'>  <span class="c1"># routes.rb:</span>
</span><span class='line'>  <span class="c1">#   resources :categories do</span>
</span><span class='line'>  <span class="c1">#     resources :articles</span>
</span><span class='line'>  <span class="c1">#   end</span>
</span><span class='line'>  <span class="c1">#</span>
</span><span class='line'>  <span class="c1"># load_and_authorize_resource :through =&gt; :category</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">index</span>
</span><span class='line'>    <span class="c1"># @articles is loaded and restricted here</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="c1"># @article is loaded and restricted here</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>REST API Providers</h3>

<p>I’ve started my narrative from the roots of these gems, the restriction sync between client applications and server-side REST-based APIs. Let me tell you a bit about conventions we came up with.</p>

<p>Imagine you have simple role-based CRUD interface that you want to implement on a browser side. You have index/create/update/destroy REST endpoint. Restrictions give us following questions:</p>

<ul>
<li>Which entities am I able to get through index?</li>
<li>Which entities of those are modifiable?</li>
<li>Which entities of those are destroyable?</li>
<li>Am I able to create a new entity?</li>
<li>Which fields am I able to modify for one of those entities I’m able to edit?</li>
<li>Which fields am I able to fill while creating a new entity if I’m able to?</li>
</ul>


<p>The first question is already addressed by <code>Heimdallr</code> itself. You get your scope and you simply can’t get anything besides what you are allowed to.</p>

<p>To get further with 2nd and 3d we should use meta-magic provided by <code>Heimdallr</code> proxy:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="p">{</span><span class="n">modifiable</span><span class="p">:</span> <span class="vi">@model</span><span class="o">.</span><span class="n">modifiable?</span><span class="p">,</span> <span class="n">destroyable</span><span class="p">:</span> <span class="vi">@model</span><span class="o">.</span><span class="n">destroyable?</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>@model</code> is supposed to be resricted. Add this fields to your serialization and you know the capabilities of current user.</p>

<h4>Am I able to create? And which fields?</h4>

<p><code>new</code> method is a rare guest among REST APIs. And it’s a perfect place to determine if we are able to create entity and how exactly. Here is the code to list fields we can modify:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Article</span><span class="o">.</span><span class="n">restrictions</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span><span class="o">.</span><span class="n">allowed_fields</span><span class="o">[</span><span class="ss">:create</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Within <code>Heimdallr::Resource</code> you’ll get restriction error if you can not create it at all. <code>Heimdallr</code> either defines <code>.creatable?</code> method so you can pass it on too.</p>

<h4>Which fields am I able to update</h4>

<p>The idea behind modification is quite the same. Just use <code>edit</code> method and <code>:update</code> keyword to retrieve fields that are accessible.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Article</span><span class="o">.</span><span class="n">restrictions</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span><span class="o">.</span><span class="n">allowed_fields</span><span class="o">[</span><span class="ss">:update</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Summary</h3>

<p>Using <code>Heimdallr</code> and <code>Heimdallr::Resource</code> you can get your application protected quite well with no boilerplate. And what’s not really hot: you get amazing magic for your REST APIs. So use it and be happy. Remember, Homakov is <a href="http://homakov.blogspot.com/2012/03/egor-stop-hacking-gh.html">watching you</a>!</p>

<p>ಠ_ಠ</p>

  </article>

  

<script type="text/javascript">
      var disqus_shortname = 'staalforge';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://archive.staal.io/blog/2012/04/01/heimdallr-orm-field-level-security/';
        var disqus_url = 'http://archive.staal.io/blog/2012/04/01/heimdallr-orm-field-level-security/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>


  
    <section class="comments">
      <div id="disqus_thread" aria-live="polite"></div>
    </section>
  
</div>

          </div>
          <div class="footer">
            Powered by <a href="http://octopress.org">Octopress</a>; Hosted at <a href="https://github.com/inossidabile/blog">Github</a>; Stay tuned :)
          </div>
        </td>
      </tr>
    </tbody>
  </table>
  <script type="text/javascript">
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', '4f707c6c613f5d6d0000003f');
    t.src = '//secure.gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
  </script>
</body>
</html>