
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="author" content="Boris Staal">
  
  <meta name="description" content="&larr; Back to entries Rails + REST: views nightmare Mar 24, 2012 | JSON, Pattern, REST, Rails Rails is rapidly getting more and more popular as a &hellip;">
  
  
  <link rel="canonical" href="http://staal.io/blog/2012/03/24/rails-plus-rest-avoiding-the-views-nightmare/">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr.js"></script>
  <script src="/javascripts/jquery.js"></script>
  <script src="/javascripts/application.js"></script>
  <link href="/atom.xml" rel="alternate" title="Staal Forge" type="application/atom+xml">
  <title>Rails + REST: views nightmare - Staal Forge</title>
</head>
<body>
  <table class="layoutTable" cellspacing="0" cellpadding="0">
    <tbody>
      <tr>
        <td class="layoutSidebar" >
          <div class="sidebar">
            <div class="content">
              <div class="about">
                <a href="/"><img src="/images/bs_ava.png" alt="Boris Staal"></a>
                <h1><a href="/">Boris Staal</a></h1>
                <h2>About me</h2>
                <p>
                  I'm Boris Staal, the enterpreneur geek ಠ_ಠ.
                  I do open-source and make ppl smile ^_^.
                </p>
              </div>
              <div class="follow">
                <a href="https://twitter.com/_inossidabile"><img src="/images/s_twitter.png" alt="Boris Staal"></a>
                <a href="http://facebook.com/boris.staal"><img src="/images/s_facebook.png" alt="Boris Staal"></a>
                <a href="http://github.com/inossidabile"><img src="/images/s_cat.png" alt="Boris Staal"></a>
                <a href="skype://inossidabile."><img src="/images/s_skype.png" alt="Boris Staal"></a>
              </div>
              <div class="projects">
                <h2>Projects I'm part of:</h2>
                <div class="list">
                  <div class="project joosy">
                    <a href="http://joosy.ws">Joosy</a>
                    <p>Rails-flavored browser applications framework</p>
                  </div>
                  <div class="project roundbank">
                    <a href="https://github.com/roundbank">Roundbank</a>
                    <p>Open-source internet banking platform</p>
                  </div>
                  <div class="project smartkiosk">
                    <a href="https://github.com/smartkiosk">Smartkiosk</a>
                    <p>Open-source kiosk platform</p>
                  </div>
                  <div class="project rove">
                    <a href="http://rove.io">Rove.io</a>
                    <p>Service that allows you to pregenerate typical Vagrant builds</p>
                  </div>
                  <div class="project heimdallr">
                    <a href="https://github.com/roundlake/heimdallr">Protector</a>
                    <p>Comfortable white-list security restrictions for ORMs on a field level</p>
                  </div>
                  <div class="project wash_out">
                    <a href="https://github.com/inossidabile/wash_out">WashOut</a>
                    <p>Rails 3 SOAP server library</p>
                  </div>
                  <div class="project codo">
                    <a href="https://github.com/coffeedoc/codo">Codo</a>
                    <p>CoffeeScript API documentation generator</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </td>
        <td class="layoutContent">
          <div class="header">
            <ul>
              <li 
                
                >
                <a href="/">Blog</a>
              </li>
              <li
                
                >
                <a href="/blog/archives">Archives</a>
              </li>
            </ul>
          </div>
          <div class="content">
            <div class="post">
  <div class="button">
    <span>&larr;</span>
    <a href="/">Back to entries</a>
  </div>

  <article>
    <h1>Rails + REST: views nightmare</h1>
    <time>Mar 24, 2012 | <a class='category' href='/blog/categories/json/'>JSON</a>, <a class='category' href='/blog/categories/pattern/'>Pattern</a>, <a class='category' href='/blog/categories/rest/'>REST</a>, <a class='category' href='/blog/categories/rails/'>Rails</a></time>
    <p>Rails is rapidly getting more and more popular as a comfortable platform for REST services. And it really is. We do Rails in this way for quite a long time already. There is however a real problem: <strong>JSON views are unmanageable!</strong></p>

<p>At first it may look like everything’s just fine. All you need is <s>love</s> <code>.to_json</code> or <a href="https://github.com/nesquena/rabl">RABL</a> is some particular cases. But then things go wild. And you start switching JSON Builders one after another.</p>

<h3>The problem</h3>

<p>Let’s say you have a banking service. That’s like 30 models. Each has extended CRUD endpoint (extensions are maybe 3 or 4 methods per endpoint). Each model has like 10 or 12 fields which are quite common to be large strings. And off course all that stuff is insanely linked up to like 4 or 5 levels of <code>belongs_to</code>.</p>

<p>The another thing to remember is that in real life your JSON entities are not just dumps of your ActiveRecord attributes. Two very common things are conditions (whether an attribute should appear) and custom methods.</p>

<p><strong>The problem is that consumer often wants unique set of fields for EVERY method among EVERY endpoint. Set of relations&#8217; fields can differ too!</strong></p>

<!-- more -->


<p>Imagine that, you have <code>Post</code> and <code>Comment</code> CRUDs. Every CRUD has 5 methods and potentially different field sets to otput. That&rsquo;s already 10. Also when you otput <code>Post</code> you might want to inline serialized <code>Comment</code> relation. This will give you even more potential field sets for <code>Comment</code>. Imagine potential number of field sets for deeply nested entity. And every different field set has its own conditions and custom methods. We gonna die, aren&rsquo;t we?</p>

<h3>Life with pain</h3>

<p>The first thing we came with to was to leave the RABL alone. It looks fun and effective at first but you simply can not do anything complex and custom enough with that. And in real life RABL did not really go far away from basic <code>.to_json</code>. It&rsquo;s a pitty but when it comes to serialization straight declaration is the best declaration. And RABL was built upon magic.</p>

<p>We’ve tried a lot of different builders and finally stopped with <a href="http://github.com/rails/jbuilder">Jbuilder</a>. It’s both straightforward and allows boilerplate-less.</p>

<p>But the nightmare hasn’t gone. What do you do to keep your view DRY? Use partials, right. In a very short term that gave us 10-15 partials for each model. That’s <strong>30 models * 15 partials = 450 files</strong> at your <code>app/views</code> folder. Unmanageable. Again.</p>

<h3>The Presenter pattern</h3>

<p>Another approach to solve this problem with better organization is the Presenter pattern. Since our views are just ruby code it’s a good step forward to fulfill it with OOP.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># example taken from http://quickleft.com/blog/presenters-as-a-solution-to-asjson-woes-in-rails-apis</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">ResourcePresenter</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:resource</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span> <span class="n">resource</span> <span class="p">)</span>
</span><span class='line'>    <span class="vi">@resource</span> <span class="o">=</span> <span class="n">resource</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span> <span class="n">include_root</span> <span class="o">=</span> <span class="kp">false</span> <span class="p">)</span>
</span><span class='line'>    <span class="n">data_hash</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="ss">:attr1</span> <span class="o">=&gt;</span> <span class="vi">@resource</span><span class="o">.</span><span class="n">attr1</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:attr2</span> <span class="o">=&gt;</span> <span class="vi">@resource</span><span class="o">.</span><span class="n">attr2</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">data_hash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:resource</span> <span class="o">=&gt;</span> <span class="n">data_hash</span> <span class="p">}</span> <span class="k">if</span> <span class="n">include_root</span>
</span><span class='line'>    <span class="n">data_hash</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So we reduced the number of files and grouped similar sets into the one method with parameters. It&rsquo;s 1-1 number of models presenters declaring sets of fields. Time to refactor around with <a href="https://github.com/jcasimir/draper">Draper</a> gem. With help of Draper, our code turns into:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># app/decorators/article_decorator.rb</span>
</span><span class='line'><span class="k">class</span> <span class="nc">ArticleDecorator</span> <span class="o">&lt;</span> <span class="no">ApplicationDecorator</span>
</span><span class='line'>  <span class="n">decorates</span> <span class="ss">:article</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">the_very_important_fields_set</span><span class="p">(</span> <span class="n">include_root</span> <span class="o">=</span> <span class="kp">false</span> <span class="p">)</span>
</span><span class='line'>    <span class="n">data_hash</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="ss">:attr1</span> <span class="o">=&gt;</span> <span class="n">att1</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:attr2</span> <span class="o">=&gt;</span> <span class="n">attr2</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">data_hash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:resource</span> <span class="o">=&gt;</span> <span class="n">data_hash</span> <span class="p">}</span> <span class="k">if</span> <span class="n">include_root</span>
</span><span class='line'>    <span class="n">data_hash</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>But now again we stuck into the DRY problem that was initially solved by JSON builders. It should be noted that we don’t really need to work with hashes internally. We can build our response from a set of strings using Jbuilder internally at our presenters.</p>

<p>At the moment I write this Jbuilder does not allow us to inject raw JSON string into response. There is another approach to get the required result though. There is a <a href="https://github.com/rails/jbuilder/pull/23">nice fork</a> (pull request was approved so this is expected to be supported by Jbuilder very soon).</p>

<p>With help of this fork we can turn our presenter into following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># app/decorators/article_decorator.rb</span>
</span><span class='line'><span class="k">class</span> <span class="nc">ArticleDecorator</span> <span class="o">&lt;</span> <span class="no">ApplicationDecorator</span>
</span><span class='line'>  <span class="n">decorates</span> <span class="ss">:article</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">the_very_important_fields_set</span><span class="p">(</span> <span class="n">include_root</span> <span class="o">=</span> <span class="kp">false</span> <span class="p">)</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="no">Jbuilder</span><span class="o">.</span><span class="n">encode</span> <span class="k">do</span> <span class="o">|</span><span class="n">j</span><span class="o">|</span>
</span><span class='line'>      <span class="n">j</span><span class="o">.</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="ss">:attr1</span><span class="p">,</span> <span class="ss">:attr2</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:resource</span> <span class="o">=&gt;</span> <span class="n">data</span> <span class="p">}</span> <span class="k">if</span> <span class="n">include_root</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">another_set</span>
</span><span class='line'>    <span class="no">Jbuilder</span><span class="o">.</span><span class="n">encode</span> <span class="k">do</span> <span class="o">|</span><span class="n">j</span><span class="o">|</span>
</span><span class='line'>      <span class="n">j</span><span class="o">.</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="ss">:attr1</span><span class="p">,</span> <span class="ss">:attr2</span><span class="p">,</span> <span class="ss">:attr3</span><span class="p">)</span>
</span><span class='line'>      <span class="n">j</span><span class="o">.</span><span class="n">cards</span> <span class="n">card</span><span class="o">.</span><span class="n">basic_fields</span><span class="p">(</span><span class="ss">:include_transactions</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So here is the final look:</p>

<p><img src="http://media.tumblr.com/tumblr_m1ebls2GWl1r9yc7i.png" alt="" /></p>

<p>This strategy is expensive and useless for small services. But as soon as you start operating massive entities and large amounts of custom methods – this is the way. It makes your REST providers exact (serving minimum required amount fields), DRY and supportable.</p>

<h3>Keep on reading</h3>

<p>You can find some real-life experience within this post: <a href="http://blog.alerticus.ru/post/20183094648/rails-rest-avoiding-the-views-nightmare-practice">http://blog.alerticus.ru/post/20183094648/rails-rest-avoiding-the-views-nightmare-practice</a>. If you think it&rsquo;s worth trying, keep on reading :).</p>

  </article>

  

<script type="text/javascript">
      var disqus_shortname = 'staalforge';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://staal.io/blog/2012/03/24/rails-plus-rest-avoiding-the-views-nightmare/';
        var disqus_url = 'http://staal.io/blog/2012/03/24/rails-plus-rest-avoiding-the-views-nightmare/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>


  
    <section class="comments">
      <div id="disqus_thread" aria-live="polite"></div>
    </section>
  
</div>

          </div>
          <div class="footer">
            Powered by <a href="http://octopress.org">Octopress</a>; Hosted at <a href="https://github.com/inossidabile/blog">Github</a>; Stay tuned :)
          </div>
        </td>
      </tr>
    </tbody>
  </table>
  <script type="text/javascript">
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', '4f707c6c613f5d6d0000003f');
    t.src = '//secure.gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
  </script>
</body>
</html>