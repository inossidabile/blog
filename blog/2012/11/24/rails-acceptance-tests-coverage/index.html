
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="author" content="Boris Staal">
  
  <meta name="description" content="&larr; Back to entries Rails acceptance tests coverage Nov 24, 2012 | RSpec, Rails Most of our banking products share the same architecture. We use &hellip;">
  
  
  <link rel="canonical" href="http://archive.staal.io/blog/2012/11/24/rails-acceptance-tests-coverage/">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr.js"></script>
  <script src="/javascripts/jquery.js"></script>
  <script src="/javascripts/application.js"></script>
  <link href="/atom.xml" rel="alternate" title="Staal Forge" type="application/atom+xml">
  <title>Rails acceptance tests coverage - Staal Forge</title>
</head>
<body>
  <table class="layoutTable" cellspacing="0" cellpadding="0">
    <tbody>
      <tr>
        <td class="layoutSidebar" >
          <div class="sidebar">
            <div class="content">
              <div class="about">
                <a href="/"><img src="/images/bs_ava.png" alt="Boris Staal"></a>
                <h1><a href="/">Boris Staal</a></h1>
                <h2>About me</h2>
                <p>
                  I'm Boris Staal, the enterpreneur geek ಠ_ಠ.
                  I do open-source and make ppl smile ^_^.
                </p>
              </div>
              <div class="follow">
                <a href="https://twitter.com/_inossidabile"><img src="/images/s_twitter.png" alt="Boris Staal"></a>
                <a href="http://facebook.com/boris.staal"><img src="/images/s_facebook.png" alt="Boris Staal"></a>
                <a href="http://github.com/inossidabile"><img src="/images/s_cat.png" alt="Boris Staal"></a>
                <a href="skype://inossidabile."><img src="/images/s_skype.png" alt="Boris Staal"></a>
              </div>
              <div class="projects">
                <h2>Projects I'm part of:</h2>
                <div class="list">
                  <div class="project joosy">
                    <a href="http://joosy.ws">Joosy</a>
                    <p>Rails-flavored browser applications framework</p>
                  </div>
                  <div class="project roundbank">
                    <a href="https://github.com/roundbank">Roundbank</a>
                    <p>Open-source internet banking platform</p>
                  </div>
                  <div class="project smartkiosk">
                    <a href="https://github.com/smartkiosk">Smartkiosk</a>
                    <p>Open-source kiosk platform</p>
                  </div>
                  <div class="project rove">
                    <a href="http://rove.io">Rove.io</a>
                    <p>Service that allows you to pregenerate typical Vagrant builds</p>
                  </div>
                  <div class="project heimdallr">
                    <a href="https://github.com/roundlake/heimdallr">Protector</a>
                    <p>Comfortable white-list security restrictions for ORMs on a field level</p>
                  </div>
                  <div class="project wash_out">
                    <a href="https://github.com/inossidabile/wash_out">WashOut</a>
                    <p>Rails 3 SOAP server library</p>
                  </div>
                  <div class="project codo">
                    <a href="https://github.com/coffeedoc/codo">Codo</a>
                    <p>CoffeeScript API documentation generator</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </td>
        <td class="layoutContent">
          <div class="header">
            <ul>
              <li 
                
                >
                <a href="/">Blog</a>
              </li>
              <li
                
                >
                <a href="/blog/archives">Archives</a>
              </li>
            </ul>
          </div>
          <div class="content">
            <div class="post">
  <div class="button">
    <span>&larr;</span>
    <a href="/">Back to entries</a>
  </div>

  <article>
    <h1>Rails acceptance tests coverage</h1>
    <time>Nov 24, 2012 | <a class='category' href='/blog/categories/rspec/'>RSpec</a>, <a class='category' href='/blog/categories/rails/'>Rails</a></time>
    <p>Most of our banking products share the same architecture. We use Rails as a REST application server and <a href="http://www.joosy.ws">Joosy</a> application working at browser as a client. One of the greatest advantages we get is the ability to cover the whole Ruby implementation with the acceptance tests. We use <strong>requests</strong> specs that are <a href="https://github.com/rspec/rspec-rails#request-specs">part of RSpec Rails</a> integration. However it’s easier said then done: our remote banking app-server for instance has near 500 routes to test. And the number of active routes grows constantly.</p>

<p>Managing such a great amount of routes is a real pain no matter how good you organize your specs. To solve that my colleague <a href="http://twitter.com/ImGearHead">Andrew</a> prepared a small rspec plugin handling exactly this task: counting what’s tested on your behalf.  We spent several days playing with it and increasing it’s functionality. Join us and have some fun with the <a href="https://github.com/inossidabile/rspec-routes_coverage">rspec-routes_coverage</a> gem.</p>

<h3>Usage</h3>

<p>Plugin will add the following stats to your basic RSpec output:</p>

<p><img src="http://f.cl.ly/items/3F0G0l1J250j0a392m1O/rspec.png" alt="" /></p>

<!-- more -->


<p>First line is for the total number of routes you consider “actual”. By default gem will harvest all the routes your application possess. As soon as you don’t want to test some of them you can use the following code to improve the situation:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">RSpec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">routes_coverage</span><span class="o">.</span><span class="n">exclude_namespaces</span> <span class="o">=</span> <span class="sx">%w(back)</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">routes_coverage</span><span class="o">.</span><span class="n">exclude_routes</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>    <span class="sr">/^\/$/</span><span class="p">,</span>
</span><span class='line'>    <span class="sr">/^POST \/sessions/</span>
</span><span class='line'>  <span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Second line is for the number of “manually-marked-as-tested” routes. At first sight it may seem that as soon as your route got a request it can be considered tested. But sometimes it’s not. To give you some control over the situation plugin introduces the <code>describe_request</code> helper. Use it instead of RSpec’s <code>describe</code> passing in the route you want to mark as checked. Here is the tiny sample:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">describe</span> <span class="no">ItemsController</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">describe_request</span> <span class="ss">:index</span><span class="p">,</span> <span class="n">request_path</span><span class="p">:</span> <span class="s1">&#39;/items&#39;</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s1">&#39;GET&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">it</span> <span class="s1">&#39;lists items&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">get</span> <span class="s1">&#39;/items&#39;</span>
</span><span class='line'>      <span class="c1"># ...</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># another style:</span>
</span><span class='line'>  <span class="n">describe_request</span> <span class="s1">&#39;GET /items/:id&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">it</span> <span class="s1">&#39;shows item&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">get</span> <span class="s2">&quot;/items/</span><span class="si">#{</span><span class="no">Item</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="c1"># ...</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The third line contains the counter of routes that received at least one HTTP request.</p>

<p>And the final line shows you the amount of routes that were not tested in any way. So get ‘em and test ‘em!</p>

<h3>Verbosity</h3>

<p>The default output (see the screenshot) will appear at any RSpec call to provide the basic summary. However you definitely require the ability to list routes of each category. To go deeper use the <code>LIST_ROUTES_COVERAGE=true</code> option. Also you can use the Rake helper that we prepared for you:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>rake spec:requests:coverage
</span></code></pre></td></tr></table></div></figure>


<h3>Workflow</h3>

<p>The resulting workflow could look the following way:</p>

<ul>
<li>Include Gem</li>
<li>Exclude useless routes</li>
<li>Write tests using list of pending routes to cover it all</li>
<li>Wrap your tests into describe_request blocks to mark specs as manually checked</li>
<li>Start “green acceptance” party</li>
</ul>


<p>Enjoy! :)</p>

  </article>

  

<script type="text/javascript">
      var disqus_shortname = 'staalforge';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://archive.staal.io/blog/2012/11/24/rails-acceptance-tests-coverage/';
        var disqus_url = 'http://archive.staal.io/blog/2012/11/24/rails-acceptance-tests-coverage/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>


  
    <section class="comments">
      <div id="disqus_thread" aria-live="polite"></div>
    </section>
  
</div>

          </div>
          <div class="footer">
            Powered by <a href="http://octopress.org">Octopress</a>; Hosted at <a href="https://github.com/inossidabile/blog">Github</a>; Stay tuned :)
          </div>
        </td>
      </tr>
    </tbody>
  </table>
  <script type="text/javascript">
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', '4f707c6c613f5d6d0000003f');
    t.src = '//secure.gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
  </script>
</body>
</html>